# image.yaml - Distrobuilder template for Atlantis appliance
# Base: Debian Bookworm with cloud-init support
image:
  distribution: debian
  release: bookworm
  description: "Atlantis Terraform/OpenTofu Pull Request automation appliance"

source:
  downloader: debootstrap
  url: http://deb.debian.org/debian

packages:
  manager: apt
  update: true
  cleanup: true
  sets:
    - packages:
        # Base system
        - ca-certificates
        - curl
        - wget
        - tzdata
        - logrotate
        - gnupg
        - unzip
        # cloud-init for last-mile configuration
        - cloud-init
        # systemd for service management
        - systemd
        - systemd-sysv
        - dbus
        # Networking
        - iproute2
        - iputils-ping
        # Git (required for Atlantis)
        - git
      action: install

files:
  - path: /etc/atlantis/atlantis.yaml
    generator: dump
    content: |-
      # Atlantis Server-Side Repo Config
      # See: https://www.runatlantis.io/docs/server-side-repo-config
      repos:
        - id: /.*/
          allowed_overrides: [workflow, apply_requirements, delete_source_branch_on_merge]
          allow_custom_workflows: true
    mode: "0644"

  - path: /etc/atlantis/env
    generator: dump
    content: |-
      # Atlantis environment configuration
      # Configure these values for your environment

      # Required: GitHub/GitLab/Bitbucket configuration
      # ATLANTIS_GH_USER=your-github-user
      # ATLANTIS_GH_TOKEN=your-github-token
      # ATLANTIS_GH_WEBHOOK_SECRET=your-webhook-secret

      # Required: Repository allowlist (use * for all repos from a user/org)
      # ATLANTIS_REPO_ALLOWLIST=github.com/your-org/*

      # Server configuration
      ATLANTIS_PORT=4141
      ATLANTIS_DATA_DIR=/var/lib/atlantis
      ATLANTIS_REPO_CONFIG=/etc/atlantis/atlantis.yaml

      # Optional: Atlantis URL (for links in PR comments)
      # ATLANTIS_ATLANTIS_URL=https://atlantis.example.com
    mode: "0600"

  - path: /etc/systemd/system/atlantis.service
    generator: dump
    content: |-
      [Unit]
      Description=Atlantis Terraform Pull Request Automation
      Documentation=https://www.runatlantis.io/docs
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      User=atlantis
      Group=atlantis
      EnvironmentFile=/etc/atlantis/env
      ExecStart=/usr/local/bin/atlantis server
      Restart=on-failure
      RestartSec=5

      # Security hardening
      NoNewPrivileges=yes
      ProtectSystem=strict
      ProtectHome=yes
      ReadWritePaths=/var/lib/atlantis
      PrivateTmp=yes

      [Install]
      WantedBy=multi-user.target
    mode: "0644"

  - path: /etc/motd
    generator: dump
    content: |-
      ╔══════════════════════════════════════════════════╗
      ║  Atlantis Appliance                              ║
      ║  Incus Appliance Registry                        ║
      ╠══════════════════════════════════════════════════╣
      ║  Config: /etc/atlantis/                          ║
      ║  Data:   /var/lib/atlantis/                      ║
      ║  Logs:   journalctl -u atlantis                  ║
      ║  Status: systemctl status atlantis               ║
      ╚══════════════════════════════════════════════════╝

      Configure Atlantis by editing /etc/atlantis/env with your
      GitHub/GitLab/Bitbucket credentials and webhook secret.

      Supports cloud-init for automated configuration.
      See: incus config set <instance> cloud-init.user-data ...
    mode: "0644"

  - path: /etc/cloud/cloud.cfg.d/99-incus.cfg
    generator: dump
    content: |-
      # Incus/LXD datasource configuration
      datasource_list: [LXD]
      datasource:
        LXD:
          apply_network_config: true
    mode: "0644"

actions:
  - trigger: post-unpack
    action: |-
      #!/bin/sh
      set -eux

      # Ensure directories exist
      mkdir -p /var/lib/atlantis
      mkdir -p /etc/atlantis

  - trigger: post-packages
    action: |-
      #!/bin/sh
      set -eux

      # Create atlantis user
      useradd --system --home-dir /var/lib/atlantis --shell /usr/sbin/nologin atlantis

      # Download and install Atlantis
      ATLANTIS_VERSION="0.37.1"
      ARCH=$(dpkg --print-architecture)

      cd /tmp
      wget -q "https://github.com/runatlantis/atlantis/releases/download/v${ATLANTIS_VERSION}/atlantis_linux_${ARCH}.zip"
      unzip -q "atlantis_linux_${ARCH}.zip"
      mv atlantis /usr/local/bin/
      chmod +x /usr/local/bin/atlantis
      rm -f "atlantis_linux_${ARCH}.zip"

      # Verify installation
      /usr/local/bin/atlantis version

      # Enable cloud-init services
      systemctl enable cloud-init-local.service
      systemctl enable cloud-init.service
      systemctl enable cloud-config.service
      systemctl enable cloud-final.service

      # Disable unnecessary services for containers
      systemctl disable apt-daily.timer || true
      systemctl disable apt-daily-upgrade.timer || true

  - trigger: post-files
    action: |-
      #!/bin/sh
      set -eux

      # Enable atlantis service (service file is created in files section)
      systemctl enable atlantis

      # Set permissions
      chown -R atlantis:atlantis /var/lib/atlantis
      chown -R atlantis:atlantis /etc/atlantis

      # Clean up package cache
      apt-get clean
      rm -rf /var/lib/apt/lists/*
      rm -rf /tmp/*
      rm -rf /var/tmp/*
