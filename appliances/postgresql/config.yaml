# config.yaml - Incus cloud-init configuration for PostgreSQL appliance
# This file configures the container using cloud-init

config:
  cloud-init.user-data: |
    #cloud-config
    package_update: true
    package_upgrade: false

    packages:
      # Base system
      - ca-certificates
      - curl
      - tzdata
      - logrotate
      # Networking
      - iproute2
      - iputils-ping
      # PostgreSQL (Debian's default version)
      - postgresql
      - postgresql-contrib

    write_files:
      - path: /etc/motd
        permissions: '0644'
        content: |
          =====================================================
            PostgreSQL Appliance
            Incus Appliance Registry
          =====================================================
            Data:   /var/lib/postgresql/
            Config: /etc/postgresql/
            Logs:   /var/log/postgresql/
            Status: systemctl status postgresql
          =====================================================

          Default: PostgreSQL is configured to accept local connections only.
          Use cloud-init or manual configuration to allow remote access.

          Supports cloud-init for automated configuration.
          See: incus config set <instance> cloud-init.user-data ...

      - path: /etc/logrotate.d/postgresql
        permissions: '0644'
        content: |
          /var/log/postgresql/*.log {
              daily
              missingok
              rotate 14
              compress
              delaycompress
              notifempty
              create 0640 postgres postgres
              sharedscripts
              postrotate
                  /usr/bin/pg_ctlcluster --quiet $(pg_lsclusters -h | awk '{print $1, $2}') reload > /dev/null 2>&1 || true
              endscript
          }

      - path: /etc/cloud/cloud.cfg.d/99-incus.cfg
        permissions: '0644'
        content: |
          # Incus/LXD datasource configuration
          datasource_list: [LXD]
          datasource:
            LXD:
              apply_network_config: true

    runcmd:
      # Ensure PostgreSQL directories exist
      - mkdir -p /var/lib/postgresql /var/log/postgresql
      # Enable PostgreSQL at boot
      - systemctl enable postgresql
      # Set permissions
      - chown -R postgres:postgres /var/lib/postgresql
      - chown -R postgres:postgres /var/log/postgresql
      # Disable unnecessary services for containers
      - systemctl disable apt-daily.timer || true
      - systemctl disable apt-daily-upgrade.timer || true
