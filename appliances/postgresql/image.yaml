# image.yaml - Distrobuilder template for PostgreSQL appliance
# Base: Debian Bookworm with cloud-init support
image:
  distribution: debian
  release: bookworm
  description: "PostgreSQL database server appliance"

source:
  downloader: debootstrap
  url: http://deb.debian.org/debian

packages:
  manager: apt
  update: true
  cleanup: true
  sets:
    - packages:
        # Base system
        - ca-certificates
        - curl
        - tzdata
        - logrotate
        # cloud-init for last-mile configuration
        - cloud-init
        # systemd for service management
        - systemd
        - systemd-sysv
        - dbus
        # Networking
        - iproute2
        - iputils-ping
        # PostgreSQL (Debian's default version)
        - postgresql
        - postgresql-contrib
      action: install

files:
  - path: /etc/motd
    generator: dump
    content: |-
      ╔══════════════════════════════════════════════════╗
      ║  PostgreSQL Appliance                            ║
      ║  Incus Appliance Registry                        ║
      ╠══════════════════════════════════════════════════╣
      ║  Data:   /var/lib/postgresql/                    ║
      ║  Config: /etc/postgresql/                        ║
      ║  Logs:   /var/log/postgresql/                    ║
      ║  Status: systemctl status postgresql             ║
      ╚══════════════════════════════════════════════════╝

      Default: PostgreSQL is configured to accept local connections only.
      Use cloud-init or manual configuration to allow remote access.

      Supports cloud-init for automated configuration.
      See: incus config set <instance> cloud-init.user-data ...
    mode: "0644"

  - path: /etc/logrotate.d/postgresql
    generator: dump
    content: |-
      /var/log/postgresql/*.log {
          daily
          missingok
          rotate 14
          compress
          delaycompress
          notifempty
          create 0640 postgres postgres
          sharedscripts
          postrotate
              /usr/bin/pg_ctlcluster --quiet $(pg_lsclusters -h | awk '{print $1, $2}') reload > /dev/null 2>&1 || true
          endscript
      }
    mode: "0644"

  - path: /etc/cloud/cloud.cfg.d/99-incus.cfg
    generator: dump
    content: |-
      # Incus/LXD datasource configuration
      datasource_list: [LXD]
      datasource:
        LXD:
          apply_network_config: true
    mode: "0644"

actions:
  - trigger: post-unpack
    action: |-
      #!/bin/sh
      set -eux

      # Ensure PostgreSQL directories exist
      mkdir -p /var/lib/postgresql
      mkdir -p /var/log/postgresql
      mkdir -p /run/postgresql

  - trigger: post-packages
    action: |-
      #!/bin/sh
      set -eux

      # Enable PostgreSQL at boot
      systemctl enable postgresql

      # Enable cloud-init services
      systemctl enable cloud-init-local.service
      systemctl enable cloud-init.service
      systemctl enable cloud-config.service
      systemctl enable cloud-final.service

      # Disable unnecessary services for containers
      systemctl disable apt-daily.timer || true
      systemctl disable apt-daily-upgrade.timer || true

  - trigger: post-files
    action: |-
      #!/bin/sh
      set -eux

      # Set permissions
      chown -R postgres:postgres /var/lib/postgresql
      chown -R postgres:postgres /var/log/postgresql
      chown -R postgres:postgres /run/postgresql

      # Clean up package cache
      apt-get clean
      rm -rf /var/lib/apt/lists/*
      rm -rf /tmp/*
      rm -rf /var/tmp/*
