# image.yaml - Distrobuilder template for Redis appliance
# Base: Debian Bookworm with cloud-init support
image:
  distribution: debian
  release: bookworm
  description: "Redis in-memory data store appliance"

source:
  downloader: debootstrap
  url: http://deb.debian.org/debian

packages:
  manager: apt
  update: true
  cleanup: true
  sets:
    - packages:
        # Base system
        - ca-certificates
        - curl
        - tzdata
        - logrotate
        # cloud-init for last-mile configuration
        - cloud-init
        # systemd for service management
        - systemd
        - systemd-sysv
        - dbus
        # Networking
        - iproute2
        - iputils-ping
        # Redis
        - redis-server
        - redis-tools
      action: install

files:
  - path: /etc/redis/redis-appliance.conf
    generator: dump
    content: |-
      # Redis appliance configuration overrides
      # This file is included by the main redis.conf

      # Bind to all interfaces (secure with firewall or requirepass)
      bind 0.0.0.0

      # Disable protected mode to allow remote connections
      # IMPORTANT: Set a password using requirepass or use firewall rules
      protected-mode no

      # Enable AOF persistence for durability
      appendonly yes
      appendfsync everysec

      # Log to file
      logfile /var/log/redis/redis-server.log
      loglevel notice

      # Set max memory policy (comment out for unlimited)
      # maxmemory 256mb
      # maxmemory-policy allkeys-lru
    mode: "0640"

  - path: /etc/motd
    generator: dump
    content: |-
      ╔══════════════════════════════════════════════════╗
      ║  Redis Appliance                                 ║
      ║  Incus Appliance Registry                        ║
      ╠══════════════════════════════════════════════════╣
      ║  Data:   /var/lib/redis/                         ║
      ║  Config: /etc/redis/                             ║
      ║  Logs:   /var/log/redis/                         ║
      ║  Status: redis-cli ping                          ║
      ╚══════════════════════════════════════════════════╝

      Default: Redis is accessible from all interfaces without authentication.
      Set a password: redis-cli CONFIG SET requirepass "your-password"

      Supports cloud-init for automated configuration.
      See: incus config set <instance> cloud-init.user-data ...
    mode: "0644"

  - path: /etc/logrotate.d/redis-server
    generator: dump
    content: |-
      /var/log/redis/*.log {
          daily
          missingok
          rotate 14
          compress
          delaycompress
          notifempty
          create 0640 redis redis
          sharedscripts
          postrotate
              redis-cli ping > /dev/null 2>&1 || true
          endscript
      }
    mode: "0644"

  - path: /etc/cloud/cloud.cfg.d/99-incus.cfg
    generator: dump
    content: |-
      # Incus/LXD datasource configuration
      datasource_list: [LXD]
      datasource:
        LXD:
          apply_network_config: true
    mode: "0644"

actions:
  - trigger: post-unpack
    action: |-
      #!/bin/sh
      set -eux

      # Ensure Redis directories exist
      mkdir -p /var/lib/redis
      mkdir -p /var/log/redis
      mkdir -p /run/redis

  - trigger: post-packages
    action: |-
      #!/bin/sh
      set -eux

      # Enable Redis at boot
      systemctl enable redis-server

      # Enable cloud-init services
      systemctl enable cloud-init-local.service
      systemctl enable cloud-init.service
      systemctl enable cloud-config.service
      systemctl enable cloud-final.service

      # Disable unnecessary services for containers
      systemctl disable apt-daily.timer || true
      systemctl disable apt-daily-upgrade.timer || true

  - trigger: post-files
    action: |-
      #!/bin/sh
      set -eux

      # Include appliance config in main redis.conf
      echo "include /etc/redis/redis-appliance.conf" >> /etc/redis/redis.conf

      # Set permissions
      chown -R redis:redis /var/lib/redis
      chown -R redis:redis /var/log/redis
      chown -R redis:redis /run/redis
      chown redis:redis /etc/redis/redis-appliance.conf

      # Clean up package cache
      apt-get clean
      rm -rf /var/lib/apt/lists/*
      rm -rf /tmp/*
      rm -rf /var/tmp/*
