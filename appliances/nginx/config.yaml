# config.yaml - Incus cloud-init configuration for nginx appliance
# This file configures the container using cloud-init

config:
  cloud-init.user-data: |
    #cloud-config
    package_update: true
    package_upgrade: false

    packages:
      # Base system
      - ca-certificates
      - curl
      - tzdata
      - logrotate
      # Networking
      - iproute2
      - iputils-ping
      # Nginx
      - nginx

    write_files:
      - path: /etc/nginx/nginx.conf
        permissions: '0644'
        content: |
          # nginx.conf - Main nginx configuration

          user www-data;
          worker_processes auto;
          error_log /var/log/nginx/error.log warn;
          pid /run/nginx.pid;

          events {
              worker_connections 1024;
          }

          http {
              include /etc/nginx/mime.types;
              default_type application/octet-stream;

              log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                              '$status $body_bytes_sent "$http_referer" '
                              '"$http_user_agent" "$http_x_forwarded_for"';

              access_log /var/log/nginx/access.log main;

              sendfile on;
              tcp_nopush on;
              tcp_nodelay on;
              keepalive_timeout 65;
              types_hash_max_size 2048;
              server_tokens off;

              # Gzip compression
              gzip on;
              gzip_vary on;
              gzip_proxied any;
              gzip_comp_level 6;
              gzip_types text/plain text/css text/xml text/javascript
                         application/json application/javascript application/xml+rss
                         application/rss+xml font/truetype font/opentype
                         application/vnd.ms-fontobject image/svg+xml;

              # Include additional configurations
              include /etc/nginx/conf.d/*.conf;
          }

      - path: /etc/nginx/conf.d/default.conf
        permissions: '0644'
        content: |
          # default.conf - Default virtual host configuration

          server {
              listen 80 default_server;
              listen [::]:80 default_server;

              server_name _;
              root /usr/share/nginx/html;
              index index.html index.htm;

              # Health check endpoint
              location /health {
                  access_log off;
                  return 200 "healthy\n";
                  add_header Content-Type text/plain;
              }

              # Default location
              location / {
                  try_files $uri $uri/ =404;
              }

              # Error pages
              error_page 404 /404.html;
              error_page 500 502 503 504 /50x.html;
              location = /50x.html {
                  root /usr/share/nginx/html;
              }

              # Deny access to hidden files
              location ~ /\. {
                  deny all;
                  access_log off;
                  log_not_found off;
              }
          }

      - path: /etc/motd
        permissions: '0644'
        content: |
          =====================================================
            Nginx Appliance
            Incus Appliance Registry
          =====================================================
            Config: /etc/nginx/conf.d/
            Logs:   /var/log/nginx/
            Status: nginx -t && systemctl reload nginx
          =====================================================

          Supports cloud-init for automated configuration.
          See: incus config set <instance> cloud-init.user-data ...

      - path: /etc/logrotate.d/nginx
        permissions: '0644'
        content: |
          /var/log/nginx/*.log {
              daily
              missingok
              rotate 14
              compress
              delaycompress
              notifempty
              create 0640 www-data adm
              sharedscripts
              postrotate
                  systemctl reload nginx > /dev/null 2>&1 || true
              endscript
          }

      - path: /etc/cloud/cloud.cfg.d/99-incus.cfg
        permissions: '0644'
        content: |
          # Incus/LXD datasource configuration
          datasource_list: [LXD]
          datasource:
            LXD:
              apply_network_config: true

    runcmd:
      # Ensure nginx directories exist
      - mkdir -p /var/log/nginx /var/cache/nginx /run/nginx
      # Enable nginx at boot
      - systemctl enable nginx
      # Validate nginx configuration
      - nginx -t
      # Set permissions
      - chown -R www-data:www-data /var/log/nginx
      - chown -R www-data:www-data /var/cache/nginx
      - chown -R root:root /etc/nginx
      - chmod -R 755 /usr/share/nginx/html
      # Disable unnecessary services for containers
      - systemctl disable apt-daily.timer || true
      - systemctl disable apt-daily-upgrade.timer || true

# Post-files commands run after files/ directory is copied
# This is where we can do final setup that depends on copied files
post_files: |
  # Validate nginx configuration with any copied files
  nginx -t
  # Set final permissions
  chown -R www-data:www-data /var/log/nginx
  chown -R root:root /etc/nginx
