name: Build and Publish Registry

on:
  push:
    branches:
      - main
    paths:
      - 'appliances/**'
      - 'appliances.yaml'
      - 'bin/**'
      - '.github/workflows/build-and-publish.yml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      appliances: ${{ steps.set-matrix.outputs.appliances }}
      versions: ${{ steps.set-matrix.outputs.versions }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Generate build matrix
        id: set-matrix
        run: |
          # Read defaults
          DEFAULT_ARCHS=$(yq -o=json '.defaults.architectures // ["amd64", "arm64"]' appliances.yaml)

          # Generate matrix includes with version from each appliance's appliance.yaml
          MATRIX_INCLUDES=$(for appliance in $(yq -r '.appliances[] | select(.enabled != false) | .name' appliances.yaml); do
            # Read version from appliance.yaml, default to 0.0.0
            version=$(yq -r '.version // "0.0.0"' "appliances/${appliance}/appliance.yaml" 2>/dev/null || echo "0.0.0")
            archs=$(yq -o=json ".appliances[] | select(.name == \"${appliance}\") | .architectures // [\"amd64\", \"arm64\"]" appliances.yaml)
            echo "{\"appliance\": \"${appliance}\", \"version\": \"${version}\", \"archs\": ${archs}}"
          done | jq -s '[.[] | .archs[] as $arch | {appliance: .appliance, version: .version, arch: $arch}]')

          # Create the matrix object
          MATRIX=$(echo "$MATRIX_INCLUDES" | jq -c '{include: .}')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

          # Also output just the appliance names for other jobs
          APPLIANCES=$(yq -o=json '[.appliances[] | select(.enabled != false) | .name]' appliances.yaml | jq -c '.')
          echo "appliances=$APPLIANCES" >> $GITHUB_OUTPUT

          # Output appliance versions for release job
          VERSIONS=$(for appliance in $(yq -r '.appliances[] | select(.enabled != false) | .name' appliances.yaml); do
            version=$(yq -r '.version // "0.0.0"' "appliances/${appliance}/appliance.yaml" 2>/dev/null || echo "0.0.0")
            echo "{\"name\": \"${appliance}\", \"version\": \"${version}\"}"
          done | jq -s -c '.')
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT

          # Debug output
          echo "Generated matrix:"
          echo "$MATRIX" | jq .
          echo "Appliances: $APPLIANCES"
          echo "Versions: $VERSIONS"

  build:
    needs: generate-matrix
    runs-on: ubuntu-24.04
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache distrobuilder base images
        uses: actions/cache@v4
        with:
          path: .cache/distrobuilder
          key: distrobuilder-${{ matrix.appliance }}-${{ matrix.arch }}-${{ hashFiles(format('appliances/{0}/image.yaml', matrix.appliance)) }}
          restore-keys: |
            distrobuilder-${{ matrix.appliance }}-${{ matrix.arch }}-
            distrobuilder-${{ matrix.appliance }}-
            distrobuilder-

      - name: Prepare cache directory
        run: |
          # Create cache directory if it doesn't exist
          mkdir -p .cache/distrobuilder
          # Ensure distrobuilder can write to cache (runs as root)
          sudo chown -R root:root .cache/distrobuilder 2>/dev/null || true

      - name: Set up QEMU for cross-architecture builds
        if: matrix.arch != 'amd64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.arch }}

      - name: Install build dependencies
        run: |
          # Add Zabbly repository for Incus tools
          sudo mkdir -p /etc/apt/keyrings
          sudo curl -fsSL https://pkgs.zabbly.com/key.asc -o /etc/apt/keyrings/zabbly.asc
          sudo sh -c 'cat > /etc/apt/sources.list.d/zabbly-incus-stable.sources <<EOF
          Enabled: yes
          Types: deb
          URIs: https://pkgs.zabbly.com/incus/stable
          Suites: $(. /etc/os-release && echo ${VERSION_CODENAME})
          Components: main
          Architectures: $(dpkg --print-architecture)
          Signed-By: /etc/apt/keyrings/zabbly.asc
          EOF'
          sudo apt-get update
          sudo apt-get install -y incus-extra jq

      - name: Build appliance
        run: |
          sudo ./bin/build-appliance.sh ${{ matrix.appliance }} ${{ matrix.arch }}

          # Fix ownership so we can work with the files and cache can be saved
          sudo chown -R $USER:$USER .build
          # Cache directory may not exist if distrobuilder cleaned it up
          if [ -d .cache/distrobuilder ]; then
            sudo chown -R $USER:$USER .cache/distrobuilder
          fi

      - name: Prepare image files for release
        id: metadata
        run: |
          # Files are in .build/<appliance>/<arch>/
          BUILD_DIR=".build/${{ matrix.appliance }}/${{ matrix.arch }}"

          # Verify files exist
          if [ ! -f "${BUILD_DIR}/incus.tar.xz" ] || [ ! -f "${BUILD_DIR}/rootfs.squashfs" ]; then
            echo "Error: Build files not found in ${BUILD_DIR}"
            ls -la "${BUILD_DIR}" || true
            exit 1
          fi

          # Rename files to include appliance and arch for uniqueness in release
          METADATA_NAME="${{ matrix.appliance }}-${{ matrix.arch }}-incus.tar.xz"
          ROOTFS_NAME="${{ matrix.appliance }}-${{ matrix.arch }}-rootfs.squashfs"

          cp "${BUILD_DIR}/incus.tar.xz" "${BUILD_DIR}/${METADATA_NAME}"
          cp "${BUILD_DIR}/rootfs.squashfs" "${BUILD_DIR}/${ROOTFS_NAME}"

          echo "metadata_name=${METADATA_NAME}" >> $GITHUB_OUTPUT
          echo "rootfs_name=${ROOTFS_NAME}" >> $GITHUB_OUTPUT
          echo "build_dir=${BUILD_DIR}" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: images-${{ matrix.appliance }}-${{ matrix.arch }}
          path: |
            ${{ steps.metadata.outputs.build_dir }}/${{ steps.metadata.outputs.metadata_name }}
            ${{ steps.metadata.outputs.build_dir }}/${{ steps.metadata.outputs.rootfs_name }}
          retention-days: 1

      - name: Upload registry artifact
        uses: actions/upload-artifact@v4
        with:
          name: registry-${{ matrix.appliance }}-${{ matrix.arch }}
          path: registry/
          retention-days: 1

  release:
    needs: [generate-matrix, build]
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog generation

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Download all image artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: images-*
          path: release-files/
          merge-multiple: true

      - name: List downloaded files
        run: |
          echo "==> Downloaded files for release:"
          ls -lh release-files/

      - name: Generate release information
        id: release-info
        run: |
          # Get versions from the matrix output
          VERSIONS='${{ needs.generate-matrix.outputs.versions }}'

          # Generate markdown list of appliances with versions
          LIST=""
          for row in $(echo "$VERSIONS" | jq -r '.[] | @base64'); do
            name=$(echo "$row" | base64 -d | jq -r '.name')
            version=$(echo "$row" | base64 -d | jq -r '.version')
            archs=$(yq -r ".appliances[] | select(.name == \"${name}\") | .architectures // [\"amd64\", \"arm64\"] | join(\", \")" appliances.yaml)
            LIST="${LIST}- **${name}** v${version} (${archs})"$'\n'
          done

          # Calculate a combined release tag based on date
          RELEASE_DATE=$(date +%Y%m%d)
          RELEASE_TAG="v${RELEASE_DATE}"

          echo "list<<EOF" >> $GITHUB_OUTPUT
          echo "$LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "release_date=${RELEASE_DATE}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous release tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            echo "Generating changelog since ${PREV_TAG}"
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges 2>/dev/null || echo "- Initial release")
          else
            echo "No previous tag found, showing recent commits"
            CHANGELOG=$(git log -10 --pretty=format:"- %s (%h)" --no-merges 2>/dev/null || echo "- Initial release")
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create/Update Latest Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Latest Appliance Images"
          draft: false
          prerelease: false
          make_latest: true
          files: release-files/*
          body: |
            ## Latest Appliance Images

            This release contains the latest built appliance images.

            **Last updated:** ${{ github.event.head_commit.timestamp }}

            ### Usage

            Add the remote:
            ```bash
            incus remote add appliance https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }} --protocol simplestreams
            ```

            Launch an appliance (supports version tags):
            ```bash
            # Latest version
            incus launch appliance:nginx my-nginx

            # Specific version
            incus launch appliance:nginx:1.0.0 my-nginx

            # Latest in major version
            incus launch appliance:nginx:1 my-nginx
            ```

            ### Available Appliances

            ${{ steps.release-info.outputs.list }}

            ### Changes

            ${{ steps.changelog.outputs.changelog }}

      - name: Create Versioned Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-info.outputs.release_tag }}
          name: "Release ${{ steps.release-info.outputs.release_tag }}"
          draft: false
          prerelease: false
          make_latest: false
          files: release-files/*
          body: |
            ## Appliance Images - ${{ steps.release-info.outputs.release_tag }}

            **Built:** ${{ github.event.head_commit.timestamp }}

            ### Appliances

            ${{ steps.release-info.outputs.list }}

            ### Changes

            ${{ steps.changelog.outputs.changelog }}

  publish:
    needs: [generate-matrix, build]
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Download all registry artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: registry-*
          path: registries/

      - name: Merge registries
        run: |
          mkdir -p merged-registry/streams/v1
          mkdir -p merged-registry/images

          # List what we downloaded
          echo "==> Downloaded artifacts:"
          ls -la registries/

          # Initialize index.json
          cat > merged-registry/streams/v1/index.json <<'INDEXEOF'
          {
            "index": {
              "images": {
                "datatype": "image-downloads",
                "path": "streams/v1/images.json",
                "format": "products:1.0"
              }
            },
            "format": "index:1.0"
          }
          INDEXEOF

          # Merge all registry artifacts
          for reg_dir in registries/registry-*; do
            echo "==> Processing $reg_dir"
            ls -la "$reg_dir" || true

            # Handle both nested and flat structures
            if [ -d "$reg_dir/registry" ]; then
              echo "  Found nested registry structure"
              cp -r "$reg_dir/registry"/* merged-registry/ 2>/dev/null || true
            elif [ -d "$reg_dir/streams" ]; then
              echo "  Found flat registry structure"
              cp -r "$reg_dir"/* merged-registry/ 2>/dev/null || true
            fi
          done

          echo "==> Merged registry contents:"
          find merged-registry -type f

      - name: Generate index.html from manifest
        run: |
          # Generate appliance list HTML with versions
          APPLIANCE_HTML=""
          for appliance in $(yq -r '.appliances[] | select(.enabled != false) | .name' appliances.yaml); do
            version=$(yq -r '.version // "0.0.0"' "appliances/${appliance}/appliance.yaml" 2>/dev/null || echo "0.0.0")
            description=$(yq -r ".appliances[] | select(.name == \"${appliance}\") | .description // \"Appliance\"" appliances.yaml)
            archs=$(yq -r ".appliances[] | select(.name == \"${appliance}\") | .architectures // [\"amd64\", \"arm64\"] | join(\", \")" appliances.yaml)
            APPLIANCE_HTML="${APPLIANCE_HTML}<li><strong>${appliance}</strong> v${version} - ${description} (${archs})</li>"
          done

          cat > merged-registry/index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>Incus Appliance Registry</title>
            <style>
              body { font-family: system-ui; max-width: 800px; margin: 40px auto; padding: 0 20px; }
              code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
              pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
              li { margin: 8px 0; }
            </style>
          </head>
          <body>
            <h1>Incus Appliance Registry</h1>
            <p>SimpleStreams image server for pre-configured Incus system containers.</p>

            <h2>Quick Start</h2>
            <pre><code>incus remote add appliance https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }} --protocol simplestreams
          incus launch appliance:nginx my-nginx</code></pre>

            <h2>Available Appliances</h2>
            <ul>
          ${APPLIANCE_HTML}
            </ul>

            <h2>Documentation</h2>
            <p>See the <a href="https://github.com/${{ github.repository }}">GitHub repository</a> for full documentation.</p>
          </body>
          </html>
          EOF

      - name: List final registry contents
        run: |
          echo "==> Final registry structure:"
          find merged-registry -type f

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: merged-registry/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  summary:
    needs: [generate-matrix, release, publish]
    runs-on: ubuntu-24.04
    if: success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Create summary
        run: |
          echo "## âœ… Registry published successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Registry URL" >> $GITHUB_STEP_SUMMARY
          echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Quick Start" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Add the remote" >> $GITHUB_STEP_SUMMARY
          echo "incus remote add appliance https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }} --protocol simplestreams" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Launch an appliance" >> $GITHUB_STEP_SUMMARY
          echo "incus launch appliance:<name> my-instance" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Built Appliances" >> $GITHUB_STEP_SUMMARY
          for appliance in $(yq -r '.appliances[] | select(.enabled != false) | .name' appliances.yaml); do
            version=$(yq -r '.version // "0.0.0"' "appliances/${appliance}/appliance.yaml" 2>/dev/null || echo "0.0.0")
            archs=$(yq -r ".appliances[] | select(.name == \"${appliance}\") | .architectures // [\"amd64\", \"arm64\"] | join(\", \")" appliances.yaml)
            echo "- **${appliance}** v${version} (${archs})" >> $GITHUB_STEP_SUMMARY
          done
